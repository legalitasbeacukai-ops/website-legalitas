<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cek Resi — Generate PDF</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="watermark">FOR EDUCATIONAL / SAMPLE</div>

  <header class="site-header">
    <div class="brand">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Indonesian_coat_of_arms.svg/240px-Indonesian_coat_of_arms.svg.png" alt="logo">
      <div>
        <h1>Direktorat Jenderal Bea dan Cukai</h1>
        <div class="small">Demo pendidikan</div>
      </div>
    </div>
  </header>

  <nav class="site-nav container">
    <a href="index.html">Home</a>
    <a href="cek.html">Cek Resi & Generate PDF</a>
    <a href="surat.html">Contoh Surat</a>
  </nav>

  <main class="container">
    <div class="grid">
      <div class="card">
        <h3>Form Cek Resi</h3>
        <label for="resi">Nomor Resi</label>
        <input id="resi" placeholder="Contoh: 001776475192">

        <label for="pengirim">Nama Pengirim</label>
        <input id="pengirim" placeholder="Nama pengirim">

        <label for="penerima">Nama Penerima</label>
        <input id="penerima" placeholder="Nama penerima">

        <label for="note">Catatan (opsional)</label>
        <textarea id="note" rows="3" placeholder="Catatan tambahan..."></textarea>

        <button id="btnCek" class="btn" style="margin-top:12px">Tampilkan Surat</button>
        <button id="btnClear" class="btn secondary" style="margin-left:8px">Kosongkan</button>
      </div>

      <div class="card preview" id="previewArea">
        <div id="previewPlaceholder" class="center small">Isi form di sebelah kiri lalu klik <strong>"Tampilkan Surat"</strong>.</div>
        <div id="previewContent" style="display:none"></div>

        <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
          <button id="btnPdf" class="btn" style="display:none">Download PDF</button>
          <button id="btnPrint" class="btn secondary" style="display:none">Print</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">© 2025 Direktorat Jenderal Bea dan Cukai (Demo)</div>
  </footer>

  <script src="js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const btnCek = document.getElementById('btnCek');
    const btnClear = document.getElementById('btnClear');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const previewContent = document.getElementById('previewContent');
    const btnPdf = document.getElementById('btnPdf');
    const btnPrint = document.getElementById('btnPrint');

    function showLetter(){
      const resi = document.getElementById('resi').value.trim();
      const pengirim = document.getElementById('pengirim').value.trim();
      const penerima = document.getElementById('penerima').value.trim();
      const note = document.getElementById('note').value.trim();

      if(!resi || !pengirim || !penerima){
        alert("Lengkapi Nomor Resi, Nama Pengirim, dan Nama Penerima.");
        return;
      }

      previewContent.innerHTML = buildLetterHTML({resi,pengirim,penerima,note});
      previewPlaceholder.style.display = 'none';
      previewContent.style.display = 'block';
      btnPdf.style.display = 'inline-block';
      btnPrint.style.display = 'inline-block';
      previewContent.scrollIntoView({behavior:"smooth"});
    }

    btnCek.addEventListener('click', showLetter);
    btnClear.addEventListener('click', ()=>{
      document.getElementById('resi').value='';
      document.getElementById('pengirim').value='';
      document.getElementById('penerima').value='';
      document.getElementById('note').value='';
      previewContent.style.display='none';
      previewPlaceholder.style.display='block';
      btnPdf.style.display='none';
      btnPrint.style.display='none';
    });

    btnPrint.addEventListener('click', ()=>{
      const w = window.open('', '_blank');
      w.document.write('<html><head><title>Print Surat</title>');
      w.document.write('<link rel="stylesheet" href="css/styles.css">');
      w.document.write('</head><body>');
      w.document.write(document.getElementById('previewContent').innerHTML);
      w.document.write('</body></html>');
      w.document.close();
      setTimeout(()=>w.print(), 400);
    });

    async function loadImageAsDataURL(url){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = ()=>{
          const c = document.createElement('canvas');
          c.width = img.naturalWidth;
          c.height = img.naturalHeight;
          c.getContext('2d').drawImage(img,0,0);
          resolve(c.toDataURL('image/png'));
        };
        img.onerror = reject;
        img.src = url;
      });
    }

    btnPdf.addEventListener('click', async ()=>{
      btnPdf.disabled = true;
      btnPdf.textContent = 'Mempersiapkan PDF...';

      try{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit:'pt', format:'a4' });
        const margin = 40;
        const pageWidth = doc.internal.pageSize.getWidth();

        const letterEl = document.getElementById('previewContent').querySelector('#letterContent');
        if(!letterEl){
          alert("Tidak ada konten surat untuk di-download.");
          btnPdf.disabled = false;
          btnPdf.textContent = 'Download PDF';
          return;
        }

        // write text content
        const text = letterEl.innerText;
        const lines = doc.splitTextToSize(text, pageWidth - margin*2);
        doc.setFont("Times", "Normal");
        doc.setFontSize(12);
        doc.text(lines, margin, 60);

        // add watermark text in PDF
        doc.setTextColor(200);
        doc.setFontSize(60);
        doc.text("FOR EDUCATIONAL / SAMPLE", pageWidth/2, doc.internal.pageSize.getHeight()/2, { align:"center", angle:-30 });

        // add images (stamp + signature)
        const stampImg = letterEl.querySelector('#stampRender')?.src;
        const signImg = letterEl.querySelector('#signRender')?.src;

        if(stampImg){
          const stampData = await loadImageAsDataURL(stampImg);
          doc.addImage(stampData, 'PNG', margin, doc.internal.pageSize.getHeight() - 160, 90, 90);
        }
        if(signImg){
          const signData = await loadImageAsDataURL(signImg);
          doc.addImage(signData, 'PNG', pageWidth - margin - 180, doc.internal.pageSize.getHeight() - 140, 160, 60);
        }

        doc.save('surat_legalitas.pdf');
      }catch(err){
        console.error(err);
        alert("Gagal membuat PDF. Cek console untuk detail.");
      }finally{
        btnPdf.disabled = false;
        btnPdf.textContent = 'Download PDF';
      }
    });
  </script>
</body>
  </html>
